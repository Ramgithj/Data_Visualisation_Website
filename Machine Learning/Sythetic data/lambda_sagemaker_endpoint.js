//Import AWS
let AWS = require("aws-sdk");

//Data that we are going to send to endpoint
//REPLACE THIS WITH YOUR OWN DATA!
let endpointData = {
    "instances":
        [
            {
                "start":"2019-04-27 04:00:00",
                "target": [325.4597390993403,320.59411586408953,326.1399018807518,324.8442226115454,325.3090459982476,319.0038810460538,299.1281086898283,320.9151505059407,289.63246115499595,308.99168508084114,285.97717281836896,278.4119353374185,290.39827664637454,294.7416398852909,279.66431891036507,286.54163033468507,296.23153614932806,288.79290825734086,301.65658789238955,310.40439424498135,316.7163288024696,336.38881746902234,319.47970665017436,338.6850265588005,353.8003704253998,338.3997091109567,358.58486728811596,334.73122410194713,347.8362035743386,340.5234265308172,321.22418005897504,315.1471642519055,310.320420363995,308.9461747359571,322.3053040164169,299.52981401581565,297.704717191355,306.2958701624784,295.42211286051844,316.1522088460584,311.2016582891484,305.3192851691988,307.7834765729581,335.82674164242815,335.0781397372876,345.25981770385744,354.89090296412314,343.29771994610695,349.08774722670216,350.90395496990476,367.5875807619346,341.19252235912415,353.15562894278764,337.9922987290632,354.07394289112904,320.8941774028772,327.3058279086845,335.3503201808142,321.81205237967026,305.44885282445125,306.056199804818,330.9260891534309,319.5355187951788,332.97088175434664,322.7504986774126,320.5711159226182,321.1038083204047,348.1111402766788,334.6151432813836,338.3956865593981,350.4937181688475,348.6705559291852,381.50189531834593,386.02282588099234,368.28248059444303,351.29934885186714,347.18180438396445,356.02423996485294,344.2101096502603,333.5117713858438,351.76266919091927,335.582074205194,342.09561998112844,320.9182709535981,321.2491008210057,324.87906958473724,324.5957420234665,322.9317019401465,333.92327952641364,330.0801269801796,346.80689972692204,350.93774892013863,345.0393912019742,356.0527854294914,371.59164960161,394.51337866224793,395.08082666804466,381.1839731673893,383.6098925664378,372.5900393935115,391.8050836383023,365.7341926908916,367.5316788051132,359.4041848612334,369.6728463697947,346.25234084197695,332.6176476644465,343.1885307464148,335.8163356520021,339.4965990400287,353.06974576585566,334.5532025547903,355.5518865577204,358.0341716764667,369.503449872422,374.26155524788936,395.2190660879662,399.20561176349594,384.6450630353937,373.3188956750659,406.54044843743844,408.24123246023254,389.6703295349774,393.2890517595126,381.28892760747993,375.80716247738,390.9962299722395,386.18241145943415,360.43179060100346,383.1411577852762,364.7886647210731,376.2280732646007,343.02848999656936,374.8740722854631,363.01479496785487,357.9413775745199,383.2953841436889,384.29003549705226,385.0955288208694,387.3032839824285,375.5435729839981,398.7330797897493,418.24687427321356,419.48309956325755,409.61314371037423,393.5004174945943,398.47466913008384,404.6747930273358,391.92957695230217,418.85744271651816,393.650440391925,392.5119606456881,390.26477158755966,380.62978558641447,362.93103990063406,360.219549199633,381.1399214815164,376.6977151234303,354.7059240602284]
            }
        ],
    "configuration":
        {
            "num_samples": 50,
            "output_types":["mean","quantiles","samples"],
            "quantiles":["0.1","0.9"]
        }
};

//Name of endpoint
//REPLACE THIS WITH THE NAME OF YOUR ENDPOINT
const endpointName = "synthetic";

//Parameters for calling endpoint
let params = {
    EndpointName: endpointName,
    Body: JSON.stringify(endpointData),
    ContentType: "application/json",
    Accept: "application/json"
};

//AWS class that will query endpoint
let awsRuntime = new AWS.SageMakerRuntime({});

//Handler for Lambda function
exports.handler = event => {
    //Call endpoint and handle response
    awsRuntime.invokeEndpoint(params, (err, data)=>{
        if (err) {//An error occurred
            console.log(err, err.stack);

            //Return error response
            const response = {
                statusCode: 500,
                body: JSON.stringify('ERROR: ' + JSON.stringify(err)),
            };
            return response;
        }
        else{//Successful response
            //Convert response data to JSON
            let responseData = JSON.parse(Buffer.from(data.Body).toString('utf8'));
            console.log(JSON.stringify(responseData));

            //TODO: STORE DATA IN PREDICTION TABLE

            //Return successful response
            const response = {
                statusCode: 200,
                body: JSON.stringify('Predictions stored.'),
            };
            return response;
        }
    });
};

